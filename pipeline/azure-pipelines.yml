# Starter pipeline
# Start with a minimal pipeline that you can customize to build and deploy your code.
# Add steps that build, run tests, deploy, and more:
# https://aka.ms/yaml

trigger:
- master

variables:
  - name: subscription
    value: 'Visual Studio Enterprise' 
  - name: subscriptionId
    value: 'e66e44f5-c9bb-4501-9a65-6214bc0fd534' 
  - name: websiteName
    value: my-personal-website
  - name: location
    value: 'West Europe'
  - name: azureResourceManagerConnection
    value: 'Visual Studio Enterprise'

pool:
  vmImage: 'ubuntu-latest'

stages:
- stage: Build and Deploy
  displayName: Build stage

  jobs:
    - job : Build 
      steps:
      - task: CopyFiles@2
        inputs:
          contents: 'src/**'
          targetFolder: $(Build.ArtifactStagingDirectory)

      - task: PublishBuildArtifacts@1
        displayName: Publish build artifact
        inputs:
          artifactName: drop
    
    - job : Deploy 
      steps:
      # - task: DownloadBuildArtifacts@0
                 
      - task: AzureResourceManagerTemplateDeployment@3
        inputs:
          deploymentScope: 'Resource Group'
          azureResourceManagerConnection: $(azureResourceManagerConnection)
          subscriptionId: '$(subscriptionId)'
          action: 'Create Or Update Resource Group'
          resourceGroupName: '$(websiteName)-rg'
          location: $(location)
          templateLocation: 'Linked artifact'
          csmFile: '$(Build.ArtifactStagingDirectory)/website-resources.json'
          csmParametersFile: '$(Build.ArtifactStagingDirectory)/azuredeploy.parameters.json'
          overrideParameters: '-name $(websiteName) -location $(location)'
          deploymentMode: 'Incremental'

      - task: AzureResourceGroupDeployment@2
        inputs:
          azureSubscription: $(subscription)
          resourceGroupName: $(resourceGroupName)
          location: 'West Europe'
